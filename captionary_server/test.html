<!<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Websocket Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.js" integrity="sha256-fNXJFIlca05BIO2Y5zh1xrShK3ME+/lYZ0j+ChxX2DA="
        crossorigin="anonymous"></script>
</head>

<div class="container">
    <div class="row">
        <div class="col-7 justify-content-center">
            <img src="#" id="image" class="img-fluid" style="border: 1px solid grey;" />
        </div>
    </div>
    <div class="row">
        <div class="col-7 justify-content-center">
            <h3>Caption Vote</h3>
            <h4 id="winner"></h4>
            <ul id="captions"></ul>
        </div>
    </div>
</div>

<body>
    <script>
        var socket = new WebSocket("ws://127.0.0.1:8001");

        var Message = {
            USER_LOGGED_IN: "UserLoginResponse",
            CHAT_MESSAGE_RECIEVED: "ChatMessageResponse",
            USER_JOINED_ROOM: "UserJoinedRoomResponse",
            GAME_STARTED: "GameStartedResponse",
            ROUND_STARTED: "RoundStartResponse",
            SUBMISSION_CLOSED: "SubmissionClosedResponse",
            ROUND_FINISHED: "RoundFinishedResponse"
        };

        var Login = function (username) {
            var loginParams = {
                UserLogin: {
                    username: username
                }
            };

            socket.send(JSON.stringify(loginParams));
        };

        var JoinRoom = function (roomId) {
            var roomParams = {
                JoinRoom: {}
            };

            if (roomId) {
                roomParams["JoinRoom"]["room_id"] = roomId;
            }

            socket.send(JSON.stringify(roomParams));
        }

        var SubmitCaption = function (captionText) {
            if (!GameState.canSubmitCaption) {
                console.error("Can't submit Captions!");
            }

            var captionParams = {
                SubmitCaption: {
                    round_id: GameState.round.id,
                    caption_text: captionText
                }
            };

            socket.send(JSON.stringify(captionParams));
        };

        var SendMessage = function (messageText) {
            var messageParams = {
                ChatSent: {
                    message_text: messageText
                }
            };
            socket.send(JSON.stringify(messageParams));
        };

        var Vote = function(captionId) {
            var voteParams = {
                CaptionVote: {
                    caption_id: captionId
                }
            }

            socket.send(JSON.stringify(voteParams));
        };

        var GameState = {
            room: null,
            user: null,
            game: null,
            round: null,
            canSubmitCaption: false,
            canVote: false
        }

        socket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            console.log(data);
            switch (data.type) {
                case Message.USER_LOGGED_IN:
                    if(GameState.user == null) {
                        GameState.user = data.user;
                        console.log("Logged in as: " + GameState.user.username);
                    }
                    break;
                case Message.USER_JOINED_ROOM:
                    if(GameState.room == null) {
                        GameState.room = data.room;
                    }
                    console.log("User logged in to Room: " + data.room.id);
                    break;
                case Message.CHAT_MESSAGE_RECIEVED:
                    console.log(data.username + " says: " + data.message_text);
                    break;
                case Message.GAME_STARTED:
                    GameState.game = data.game;
                    console.log("Game Started: ID #" + GameState.game.id);
                    break;
                case Message.ROUND_STARTED:
                    if(data.game_id != GameState.game.id) {
                        return;
                    }
                    $("#winner").text("");
                    GameState.round = data.round;
                    GameState.canSubmitCaption = true;
                    console.log("Round Started for Game # " + GameState.game.id + ": ID #" + GameState.round.id);
                    $("#image").attr("src", GameState.round.image_url);
                    break;
                case Message.SUBMISSION_CLOSED:
                    if(data.game_id != GameState.game.id) {
                        return;
                    }
                    console.log("Submission closed for Round #" + data.round_id);
                    for(var i in data.captions) {
                        $("#captions").append($("<li></li>", { 
                            text: "Vote " + data.captions[i].user_id + " for: " + data.captions[i].text
                        }));
                    }
                    GameState.canSubmitCaption = false;
                    GameState.canVote = true;
                    break;
                case Message.ROUND_FINISHED:
                    console.log("Round finished: #" + data.round_id);
                    $("#captions").empty();
                    var cap = data.winning_caption;
                    $("#winner").text("Winner: \""+cap.text+"\" from: " + cap.user_id)
                    break;
                default:
                    console.warn("Unknown Message: " + e.data);
                    break;
            }
        };

        socket.onopen = function (e) { };
    </script>

</body>

</html>